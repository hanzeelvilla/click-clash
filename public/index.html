<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Click Clash</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>Click Clash</h1>
          <p>El primero en llegar al objetivo gana.</p>
        </div>
        <div style="text-align: right; color: var(--muted)">
          Conecta tus placas y presiona para competir
        </div>
      </header>

      <div class="board">
        <div class="player" id="p1">
          <div class="shadow-glow"></div>
          <div class="label">
            <div class="color-badge">
              <div class="color-dot" style="background: var(--p1)"></div>
              <span id="badge-p1">JUGADOR AZUL</span>
            </div>
          </div>
          <div class="count" id="count-p1">
            0 <small id="label-p1">P1</small>
          </div>
          <div class="progress-wrap">
            <div class="progress p1" id="prog-p1">
              <div class="bar" id="bar-p1"></div>
            </div>
          </div>
          <div class="controls">
            <button class="btn ghost" id="sim-p1">Simular press P1</button>
          </div>
        </div>

        <div class="player" id="p2">
          <div class="shadow-glow"></div>
          <div class="label">
            <div class="color-badge">
              <div class="color-dot" style="background: var(--p2)"></div>
              <span id="badge-p2">JUGADOR ROJO</span>
            </div>
          </div>
          <div class="count" id="count-p2">
            0 <small id="label-p2">P2</small>
          </div>
          <div class="progress-wrap">
            <div class="progress p2" id="prog-p2">
              <div class="bar" id="bar-p2"></div>
            </div>
          </div>
          <div class="controls">
            <button class="btn ghost" id="sim-p2">Simular press P2</button>
          </div>
        </div>
      </div>

      <div class="admin">
        <label style="color: var(--muted); font-weight: 700">Objetivo:</label>
        <input id="target" type="number" value="10" />
        <button class="btn set" id="set-target">Set</button>
        <button class="btn start" id="start">Start</button>
        <button class="btn reset" id="reset">Reset</button>
        <div style="flex: 1"></div>
        <div id="winner-banner" class="winner-banner">
          Ganador: <span id="winner-name"></span>
        </div>
      </div>

      <!-- countdown overlay (hidden by default) -->
      <div id="countdown-overlay" class="hidden">
        <div class="box">
          <div class="num" id="countdown-num">3</div>
          <div class="text">Preparados...!</div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const els = {
        p1: document.getElementById("count-p1"),
        p2: document.getElementById("count-p2"),
        labelP1: document.getElementById("label-p1"),
        labelP2: document.getElementById("label-p2"),
        badgeP1: document.getElementById("badge-p1"),
        badgeP2: document.getElementById("badge-p2"),
        barP1: document.getElementById("bar-p1"),
        barP2: document.getElementById("bar-p2"),
        target: document.getElementById("target"),
        winnerBanner: document.getElementById("winner-banner"),
        winnerName: document.getElementById("winner-name"),
      };

      function animateCount(el) {
        el.classList.add("pulse");
        setTimeout(() => el.classList.remove("pulse"), 360);
      }

      // Ensure labels show as "JUGADOR <NAME>" unless already prefixed
      function formatPlayerLabel(raw) {
        if (!raw) return raw;
        try {
          if (/^\s*jugador\b/i.test(String(raw))) return String(raw);
        } catch (e) {
          return String(raw);
        }
        return "JUGADOR " + String(raw);
      }

      function renderState(state) {
        const pMap = {};
        state.players.forEach((p) => (pMap[p.id] = p));

        const t = Number(state.target) || 10;

        const c1 = (pMap.p1 && pMap.p1.count) || 0;
        const c2 = (pMap.p2 && pMap.p2.count) || 0;

        // update counts (preserve small label node)
        els.p1.firstChild.nodeValue = c1 + " ";
        els.p2.firstChild.nodeValue = c2 + " ";
        animateCount(els.p1);
        animateCount(els.p2);

        if (pMap.p1 && pMap.p1.label) {
          const formatted = formatPlayerLabel(pMap.p1.label);
          els.labelP1.textContent = formatted;
          if (els.badgeP1) els.badgeP1.textContent = formatted;
        }
        if (pMap.p2 && pMap.p2.label) {
          const formatted = formatPlayerLabel(pMap.p2.label);
          els.labelP2.textContent = formatted;
          if (els.badgeP2) els.badgeP2.textContent = formatted;
        }

        const pct1 = Math.min(100, Math.round((c1 / t) * 100));
        const pct2 = Math.min(100, Math.round((c2 / t) * 100));
        els.barP1.style.width = pct1 + "%";
        els.barP2.style.width = pct2 + "%";

        if (state.winner) {
          const rawWinnerLabel =
            (state.players.find((p) => p.id === state.winner) || {}).label ||
            state.winner;
          const winnerLabel = formatPlayerLabel(rawWinnerLabel);
          els.winnerName.textContent = winnerLabel;
          els.winnerBanner.classList.add("show");
          els.winnerBanner.style.background =
            state.winner === "p1"
              ? "linear-gradient(90deg,var(--p1),#60a5fa)"
              : "linear-gradient(90deg,var(--p2),#f87171)";
          els.winnerBanner.style.color =
            state.winner === "p1" ? "#06103a" : "#361010";
        } else {
          els.winnerBanner.classList.remove("show");
        }

        els.target.value = t;
      }

      socket.on("game:state", (s) => renderState(s));

      socket.on("player:update", (u) => {
        const el = document.getElementById("count-" + u.id);
        if (el) {
          el.firstChild.nodeValue = u.count + " ";
          animateCount(el);
          const t = Number(els.target.value) || 10;
          const pct = Math.min(100, Math.round((u.count / t) * 100));
          if (u.id === "p1") els.barP1.style.width = pct + "%";
          if (u.id === "p2") els.barP2.style.width = pct + "%";
        }
      });

      socket.on("game:win", (w) => {
        // fallback: show winner name if provided
        if (w && w.winner) {
          const winnerLabel = w && w.winner ? w.winner : "";
          els.winnerName.textContent = winnerLabel;
          els.winnerBanner.classList.add("show");
        }
      });

      // show a flashy winner modal + confetti and highlight the player
      const winnerModal = (function () {
        // create modal element
        const modal = document.createElement("div");
        modal.id = "winner-modal";
        modal.className = "";
        modal.innerHTML = `
          <div class="panel" id="winner-panel">
            <div class="winner-title" id="winner-title">Ganador</div>
            <div class="winner-sub" id="winner-sub">¡Felicidades!</div>
            <div class="winner-actions">
              <button class="btn start" id="play-again">Jugar otra vez</button>
              <button class="btn reset" id="close-winner">Cerrar</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // confetti container
        const confettiContainer = document.createElement("div");
        confettiContainer.className = "confetti-container";
        document.body.appendChild(confettiContainer);

        function clearConfetti() {
          confettiContainer.innerHTML = "";
        }

        function emitConfetti(color) {
          clearConfetti();
          const count = 36;
          for (let i = 0; i < count; i++) {
            const el = document.createElement("div");
            el.className = "confetti";
            el.style.background = color;
            // random start position across the screen width
            el.style.left = Math.random() * 100 + "%";
            el.style.top = -10 - Math.random() * 20 + "vh";
            const delay = Math.random() * 0.4;
            const duration = 2 + Math.random() * 1.2;
            el.style.animation = `confetti-fall ${duration}s ${delay}s linear forwards`;
            confettiContainer.appendChild(el);
          }
          // clear after 4s
          setTimeout(clearConfetti, 4200);
        }

        // play again and close handlers
        modal.addEventListener("click", (ev) => {
          if (ev.target && ev.target.id === "play-again") {
            socket.emit("game:reset");
            socket.emit("game:start");
          }
          if (ev.target && ev.target.id === "close-winner") {
            modal.classList.remove("show");
          }
        });

        return {
          show(winnerId, label) {
            const panel = document.getElementById("winner-panel");
            const title = document.getElementById("winner-title");
            const sub = document.getElementById("winner-sub");
            title.textContent = label || winnerId || "";
            sub.textContent = "¡Ganó la partida!";
            modal.classList.add("show");
            // highlight card
            const pEl = document.getElementById(winnerId);
            if (pEl) pEl.classList.add("winner");
            // style modal to match winner color for better contrast
            const accent =
              winnerId === "p1"
                ? getComputedStyle(document.documentElement)
                    .getPropertyValue("--p1")
                    .trim()
                : getComputedStyle(document.documentElement)
                    .getPropertyValue("--p2")
                    .trim();
            // tint panel background slightly and add colored border
            panel.style.background = `linear-gradient(180deg, ${accent}22, rgba(2,6,23,0.95))`;
            panel.style.border = `2px solid ${accent}`;
            // make title use the accent color and increase contrast for subtext
            title.style.color = accent || "#fff";
            title.style.textShadow = "0 8px 28px rgba(0,0,0,0.6)";
            sub.style.color = "rgba(255,255,255,0.92)";

            // emit confetti in winner color
            emitConfetti(accent || "#fff");
          },
          hide() {
            modal.classList.remove("show");
            clearConfetti();
            // remove highlight
            ["p1", "p2"].forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.classList.remove("winner");
            });
          },
        };
      })();

      // react to server game:state and game:win
      socket.on("game:state", (s) => {
        renderState(s);
        if (s && s.winner) {
          const winnerLabel =
            (s.players.find((p) => p.id === s.winner) || {}).label || s.winner;
          winnerModal.show(s.winner, winnerLabel);
        } else {
          winnerModal.hide();
        }
      });

      socket.on("game:win", (w) => {
        if (w && w.winner) {
          const label = w && w.winner ? w.winner : w.winner;
          winnerModal.show(w.winner, label);
        }
      });

      document
        .getElementById("start")
        .addEventListener("click", () => socket.emit("game:start"));
      document
        .getElementById("reset")
        .addEventListener("click", () => socket.emit("game:reset"));
      document.getElementById("set-target").addEventListener("click", () => {
        const n = Number(document.getElementById("target").value) || 10;
        socket.emit("game:setTarget", n);
      });

      document
        .getElementById("sim-p1")
        .addEventListener("click", () => socket.emit("simulate:press", "p1"));
      document
        .getElementById("sim-p2")
        .addEventListener("click", () => socket.emit("simulate:press", "p2"));

      // countdown UI handling
      const overlay = document.getElementById("countdown-overlay");
      const overlayNum = document.getElementById("countdown-num");
      const simP1 = document.getElementById("sim-p1");
      const simP2 = document.getElementById("sim-p2");
      const btnStart = document.getElementById("start");
      const btnSet = document.getElementById("set-target");
      const btnReset = document.getElementById("reset");

      function setControlsDisabled(disabled) {
        simP1.disabled = disabled;
        simP2.disabled = disabled;
        btnStart.disabled = disabled;
        btnSet.disabled = disabled;
        // visually indicate disabled
        simP1.style.opacity = disabled ? 0.5 : 1;
        simP2.style.opacity = disabled ? 0.5 : 1;
        btnStart.style.opacity = disabled ? 0.6 : 1;
        btnSet.style.opacity = disabled ? 0.6 : 1;
      }

      socket.on("game:countdown", (n) => {
        if (!n || n === 0) {
          overlay.classList.add("hidden");
          setControlsDisabled(false);
        } else {
          overlay.classList.remove("hidden");
          overlayNum.textContent = String(n);
          // disable controls while counting down
          setControlsDisabled(true);
        }
      });
    </script>
  </body>
</html>
